#!/bin/sh
echo "=== Pruebas de regresión al sistema con Javascript"
# Para ejecutar en navegador visible ejecutar con
#  CONCABEZA=1 bin/pruebasjs

if (test "$PUERTODES" = "") then {
	export PUERTODES=33001;
} fi;
if (test "$IPDES" = "") then {
	export IPDES=127.0.0.1
} fi;
if (test "$RAILS_ENV" = "") then {
	export RAILS_ENV=test
} fi;
if (test "$CONFIG_HOSTS" = "") then {
	export CONFIG_HOSTS=127.0.0.1
} fi;

fstat | grep ":${PUERTODES}" 
if (test "$?" = "0") then {
  echo "Ya está corriendo un proceso en el puerto $PUERTODES, detengalo antes";
  exit 1;
} fi;
if (test ! -f .env) then {
  echo "Falta .env"
  exit 1;
} fi;
. ./.env

if (test "$IPDES" = "127.0.0.1") then {
	echo "=== Deteniendo"
	bin/detiene

	echo "=== Precompilando"
	bin/rails assets:precompile

	echo "=== Iniciando servidor"
	CONFIG_HOSTS=127.0.0.1 R=f bin/corre &

	sleep 10;
} fi;

echo "***"
w3m -dump http://${IPDES}:${PUERTODES}/${RUTA_RELATIVA}
echo "***"

cd test/puppeteer
yarn cache clean
yarn upgrade
yarn
for i in *.mjs; do
  echo "Ejecutando $i"
  node $i
done

cd ../..
bin/detiene &

