# Basado entre otros en: https://dev.to/mpressen/rails-minitest-gitlab-ci-31ap

image: "ruby:3.1.2"

services:
  - name: vtamara/postgis-es_co:13.3-1
    alias: postgres
  
variables:
  RAILS_ENV: test
  POSTGRES_ENABLED: 'true'
  POSTGRES_USER: runner
  POSTGRES_PASSWORD: ''
  POSTGRES_DB: msipdes_pru
  POSTGRES_HOST_AUTH_METHOD: trust
  NOKOGIRI_USE_SYSTEM_LIBRARIES: 'true'
  CC_TEST_REPORTER_ID: "e83ead47cfc0912ab49acb6658bf8a22bd4257d73c5ddcd8eebfb450efd51640"
  CHROMEDRIVER_DIR: /chromedriver

stages:
  - test

test:
  stage: test
  cache:
    paths:
      - apt-cache
      - node_modules
      - vendor/bundle
  before_script:
    - uname -a
    - whoami
    - echo "HOME=${HOME}"
    - pwd
    - which ruby
    - ruby -v
    - export APT_CACHE_DIR=`pwd`/apt-cache && mkdir -pv $APT_CACHE_DIR
    - apt-get update -yy && apt-get install build-essential libpq-dev postgresql-client -y
    - curl -fsSL https://deb.nodesource.com/setup_16.x | bash - # https://www.linuxcapable.com/how-to-install-node-js-14-lts-16-npm-on-debian-11-bullseye/
    - apt install -y -qq nodejs
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add # https://gitlab.com/gitlab-org/gitlab-foss/-/issues/42632-
    - sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
    - apt-get update && apt-get install -y google-chrome-stable 
    - export CHROMEDRIVER_DIR=/chromedriver
    - mkdir $CHROMEDRIVER_DIR
    - export CHROME_VERSION=$(google-chrome --product-version) | sed -e 's/^\([0-9]*\)\..*/\1/g');
    - echo $CHROME_VERSION 
    - CHROMEDRIVER_VERSION=$(curl https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION);
    - echo $CHROMEDRIVER_VERSION 
    - echo "El siguiente deberÃ­a ser https://chromedriver.storage.googleapis.com/107.0.5304.62/chromedriver_linux64.zip"
    - echo "Es http://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
    - wget -q --continue -P $CHROMEDRIVER_DIR "http://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
    - unzip $CHROMEDRIVER_DIR/chromedriver* -d $CHROMEDRIVER_DIR
    - export PATH $CHROMEDRIVER_DIR:$PATH
    - chromedriver --version
    - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
    - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    - apt-get update -qq && apt-get -o dir::cache::archives="$APT_CACHE_DIR" install -yqq yarn
    - gem install bundler --no-document
    - bundle install --jobs $(nproc) "${FLAGS[@]}"
    - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
    - chmod +x ./cc-test-reporter
    - ./cc-test-reporter before-build
    - cd test/dummy
    - cp .env.gitlab .env
    - cp db/structure.sql db/structure.sql.copia 
    - sed -e 's/provider = libc,//g;s/SET default_table_access_method.*/-- &/g' db/structure.sql.copia > db/structure.sql 
    - bin/rails db:drop db:create db:setup
    - bin/rails msip:indices
    - yarn
    - RAILS_ENV=test bin/rails assets:precompile
    - cd ../..
  script:
    - CONFIG_HOSTS=www.example.com bin/rails test
    - cd test/dummy && CONFIG_HOSTS=127.0.0.1 bin/rails test:system
    - ./cc-test-reporter after-build -t simplecov --exit-code $?

sast:
    stage: test
include:
- template: Security/SAST.gitlab-ci.yml
